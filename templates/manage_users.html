{% extends "layout.html" %}

{% block content %}
<div class="dashboard-header">
    <h1 data-en="User Management" data-pl="Zarządzanie użytkownikami">User Management</h1>
    <p data-en="Manage user roles and permissions" data-pl="Zarządzaj rolami i uprawnieniami użytkowników">Manage user roles and permissions</p>
</div>

<div class="users-container">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th data-en="Username" data-pl="Nazwa użytkownika">Username</th>
                    <th data-en="Email" data-pl="Email">Email</th>
                    <th data-en="Role" data-pl="Rola">Role</th>
                    <th data-en="Department" data-pl="Dział">Department</th>
                    <th data-en="Last Login" data-pl="Ostatnie logowanie">Last Login</th>
                    <th data-en="Actions" data-pl="Akcje">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-row-{{ user.user_id }}">
                    <td>{{ user.username }}</td>
                    <td>
                        <span class="editable-field" id="email-{{ user.user_id }}">{{ user.email }}</span>
                        <input type="email" class="edit-input d-none" value="{{ user.email }}">
                    </td>
                    <td>
                        <form action="{{ url_for('update_user_role') }}" method="POST" class="role-form">
                            <input type="hidden" name="user_id" value="{{ user.user_id }}">
                            <select name="role" onchange="this.form.submit()" {% if user.username == session.username %}disabled{% endif %}>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %} data-en="Admin" data-pl="Administrator">Admin</option>
                                <option value="user" {% if user.role == 'user' %}selected{% endif %} data-en="User" data-pl="Użytkownik">User</option>
                                <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %} data-en="Viewer" data-pl="Przeglądający">Viewer</option>
                            </select>
                        </form>
                    </td>                    <td>
                        <span class="editable-field" id="department-{{ user.user_id }}">{{ user.department }}</span>
                        <select class="edit-input d-none department-select" id="department-select-{{ user.user_id }}">
                            <option value="" data-en="Select Department" data-pl="Wybierz dział">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.name }}" 
                                    {% if dept.name == user.department %}selected{% endif %}>
                                {{ dept.name }} ({{ dept.description_en }} / {{ dept.description_pl }})
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>{{ user.last_login|default('Never') }}</td>
                    <td>
                        {% if user.username == session.username %}
                            <button class="btn btn-primary btn-sm me-2" onclick="toggleEdit({{ user.user_id }})">
                                <i class="fas fa-edit"></i> <span data-en="Edit" data-pl="Edytuj">Edit</span>
                            </button>
                            <button class="btn btn-success btn-sm me-2 d-none" onclick="saveChanges({{ user.user_id }})">
                                <i class="fas fa-save"></i> <span data-en="Save" data-pl="Zapisz">Save</span>
                            </button>
                            <button class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-trash"></i> <span data-en="Delete" data-pl="Usuń">Delete</span>
                            </button>
                        {% else %}
                            <button class="btn btn-primary btn-sm me-2" onclick="toggleEdit({{ user.user_id }})">
                                <i class="fas fa-edit"></i> <span data-en="Edit" data-pl="Edytuj">Edit</span>
                            </button>
                            <button class="btn btn-success btn-sm me-2 d-none" onclick="saveChanges({{ user.user_id }})">
                                <i class="fas fa-save"></i> <span data-en="Save" data-pl="Zapisz">Save</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser({{ user.user_id }})">
                                <i class="fas fa-trash"></i> <span data-en="Delete" data-pl="Usuń">Delete</span>
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function toggleEdit(userId) {
    const row = document.getElementById(`user-row-${userId}`);
    const editableFields = row.querySelectorAll('.editable-field');
    const editInputs = row.querySelectorAll('.edit-input');
    const editBtn = row.querySelector('.btn-primary');
    const saveBtn = row.querySelector('.btn-success');

    editableFields.forEach((field, index) => {
        field.classList.toggle('d-none');
        editInputs[index].classList.toggle('d-none');
        
        if (editInputs[index].tagName === 'SELECT') {
            // For department select, we don't need to set a value, it's already set via the selected attribute
        } else {
            editInputs[index].value = field.textContent.trim();
        }
    });

    editBtn.classList.toggle('d-none');
    saveBtn.classList.toggle('d-none');
}

function saveChanges(userId) {
    const row = document.getElementById(`user-row-${userId}`);
    const email = row.querySelector('input[type="email"]').value;
    const departmentSelect = row.querySelector('.department-select');
    const department = departmentSelect ? departmentSelect.value : row.querySelector('input[type="text"]').value;

    fetch('/api/update_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            email: email,
            department: department
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const emailField = document.getElementById(`email-${userId}`);
            const departmentField = document.getElementById(`department-${userId}`);
            emailField.textContent = email;
            
            // If department dropdown used, display department value and description
            if (departmentSelect) {
                const selectedOption = departmentSelect.options[departmentSelect.selectedIndex];
                // Display department name in the visible field
                if (selectedOption && department) {
                    // For displaying the department name only (without description)
                    departmentField.textContent = department;
                } else {
                    departmentField.textContent = '';
                }
            } else {
                departmentField.textContent = department;
            }
            
            toggleEdit(userId);
        } else {
            alert('Failed to update user information');
        }
    });
}

function deleteUser(userId) {
    const language = document.documentElement.getAttribute('data-language') || 'en';
    const confirmText = language === 'pl' ? 
        'Czy na pewno chcesz usunąć tego użytkownika?' : 
        'Are you sure you want to delete this user?';
    const failText = language === 'pl' ? 
        'Nie udało się usunąć użytkownika' : 
        'Failed to delete user';
        
    if (confirm(confirmText)) {
        fetch('/api/delete_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`user-row-${userId}`).remove();
            } else {
                alert(failText);
            }
        });
    }
}

// Function to update department descriptions (not needed with the new format)
function updateDepartmentDescriptions() {
    // We now display both English and Polish descriptions at the same time
    // Format is: Department Name (English Description / Polish Description)
    // No need to update based on language changes
}

// No need to apply translations when page loads with new format
document.addEventListener('DOMContentLoaded', function() {
    // Department descriptions are now shown in both languages
});
</script>
{% endblock %}
