{% extends "layout.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>User Management</h1>
    <p>Manage user roles and permissions</p>
</div>

<div class="users-container">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-row-{{ user.user_id }}">
                    <td>{{ user.username }}</td>
                    <td>
                        <span class="editable-field" id="email-{{ user.user_id }}">{{ user.email }}</span>
                        <input type="email" class="edit-input d-none" value="{{ user.email }}">
                    </td>
                    <td>
                        <form action="{{ url_for('update_user_role') }}" method="POST" class="role-form">
                            <input type="hidden" name="user_id" value="{{ user.user_id }}">
                            <select name="role" onchange="this.form.submit()" {% if user.username == session.username %}disabled{% endif %}>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                                <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Viewer</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <span class="editable-field" id="department-{{ user.user_id }}">{{ user.department }}</span>
                        <input type="text" class="edit-input d-none" value="{{ user.department }}">
                    </td>
                    <td>{{ user.last_login|default('Never') }}</td>
                    <td>
                        {% if user.username == session.username %}
                            <button class="btn btn-primary btn-sm me-2" onclick="toggleEdit({{ user.user_id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-success btn-sm me-2 d-none" onclick="saveChanges({{ user.user_id }})">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        {% else %}
                            <button class="btn btn-primary btn-sm me-2" onclick="toggleEdit({{ user.user_id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-success btn-sm me-2 d-none" onclick="saveChanges({{ user.user_id }})">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser({{ user.user_id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function toggleEdit(userId) {
    const row = document.getElementById(`user-row-${userId}`);
    const editableFields = row.querySelectorAll('.editable-field');
    const editInputs = row.querySelectorAll('.edit-input');
    const editBtn = row.querySelector('.btn-primary');
    const saveBtn = row.querySelector('.btn-success');

    editableFields.forEach((field, index) => {
        field.classList.toggle('d-none');
        editInputs[index].classList.toggle('d-none');
        editInputs[index].value = field.textContent.trim();
    });

    editBtn.classList.toggle('d-none');
    saveBtn.classList.toggle('d-none');
}

function saveChanges(userId) {
    const row = document.getElementById(`user-row-${userId}`);
    const email = row.querySelector('input[type="email"]').value;
    const department = row.querySelector('input[type="text"]').value;

    fetch('/api/update_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            email: email,
            department: department
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const emailField = document.getElementById(`email-${userId}`);
            const departmentField = document.getElementById(`department-${userId}`);
            emailField.textContent = email;
            departmentField.textContent = department;
            toggleEdit(userId);
        } else {
            alert('Failed to update user information');
        }
    });
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch('/api/delete_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`user-row-${userId}`).remove();
            } else {
                alert('Failed to delete user');
            }
        });
    }
}
</script>
{% endblock %}
