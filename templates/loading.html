{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
{% endblock %}

{% block content %}
<div class="loading-container">
    <div class="loading-content">
        <i class="fas fa-database loading-icon"></i>
        <h1 class="loading-title" data-en="Loading Graylog Data" data-pl="Ładowanie danych Graylog">Loading Graylog Data</h1>
        <p class="loading-message" data-en="Please wait while we fetch and process the log data..." data-pl="Proszę czekać, trwa pobieranie i przetwarzanie danych logów...">Please wait while we fetch and process the log data...</p>
        
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
        
        <p class="loading-details" id="loadingDetails" data-en="Initializing..." data-pl="Inicjalizacja...">Initializing...</p>
    </div>
</div>

<script>
    // Używamy języka przekazanego bezpośrednio z kontrolera
    const language = '{{ current_language }}' || 
                    document.documentElement.getAttribute('data-language') || 
                    (document.body.classList.contains('lang-pl') ? 'pl' : 'en');
    
    console.log("Current language detected:", language); // Logowanie wykrytego języka
    
    // Translate messages based on language
    const messages = {
        en: [
            'Connecting to Graylog server...',
            'Fetching recent logs...',
            'Processing log entries...',
            'Analyzing log patterns...',
            'Preparing data visualization...',
            'Almost done...',
            'Redirecting...'
        ],
        pl: [
            'Łączenie z serwerem Graylog...',
            'Pobieranie najnowszych logów...',
            'Przetwarzanie wpisów logów...',
            'Analizowanie wzorców logów...',
            'Przygotowanie wizualizacji danych...',
            'Prawie gotowe...',
            'Przekierowywanie...'
        ]
    };

    // Funkcja do tłumaczenia elementu
    function translateElement(element) {
        if (element && element.hasAttribute('data-pl') && language === 'pl') {
            element.textContent = element.getAttribute('data-pl');
        } else if (element && element.hasAttribute('data-en')) {
            element.textContent = element.getAttribute('data-en');
        }
    }

    // Funkcja inicjalizująca tłumaczenia na stronie
    function initTranslations() {
        console.log("Initializing translations for language:", language);
        
        // Tłumaczenie wszystkich elementów statycznych
        document.querySelectorAll('[data-en][data-pl]').forEach(translateElement);
        
        // Ustawienie początkowego komunikatu w loadingDetails
        const loadingDetails = document.getElementById('loadingDetails');
        if (loadingDetails) {
            if (language === 'pl') {
                loadingDetails.textContent = 'Inicjalizacja...';
            } else {
                loadingDetails.textContent = 'Initializing...';
            }
            console.log("Set initial loading message:", loadingDetails.textContent);
        }
    }

    // Uruchom tłumaczenia natychmiast
    document.addEventListener('DOMContentLoaded', function() {
        initTranslations();
    });
    
    // Ale na wszelki wypadek uruchom również teraz
    initTranslations();

    const progressBar = document.getElementById('progressBar');
    const loadingDetails = document.getElementById('loadingDetails');
    let currentProgress = 0;
    let messageIndex = 0;
    
    // Use the translated messages - z zabezpieczeniem przed błędami
    const languageToUse = messages[language] ? language : 'en';
    const currentMessages = messages[languageToUse];
    
    console.log("Using messages in language:", languageToUse); // Debug

    async function fetchLogs() {
        try {
            loadingDetails.textContent = currentMessages[0]; // Zapewnij, że pierwszy komunikat jest przetłumaczony
            
            const response = await fetch('/fetch_logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    force_refresh: true
                })
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            return await response.json();
        } catch (error) {
            console.error('Error fetching logs:', error);
            // Użyj odpowiednich komunikatów błędu w zależności od języka
            loadingDetails.textContent = language === 'pl' ? 
                'Błąd ładowania danych. Ponawiam próbę...' : 
                'Error loading data. Retrying...';
            return null;
        }
    }

    async function updateProgress() {
        if (currentProgress < 100) {
            if (currentProgress === 0) {
                const logsData = await fetchLogs();
                
                if (!logsData) {
                    setTimeout(updateProgress, 2000); // Retry after 2 seconds
                    return;
                }
            }

            const increment = Math.random() * 15 + 5;
            currentProgress = Math.min(currentProgress + increment, 100);
            progressBar.style.width = `${currentProgress}%`;

            // Aktualizacja komunikatu w zależności od postępu
            let newMessageIndex = Math.min(Math.floor(currentProgress / 20), currentMessages.length - 2);
            if (newMessageIndex > messageIndex) {
                messageIndex = newMessageIndex;
                loadingDetails.textContent = currentMessages[messageIndex];
                console.log("Setting message to:", currentMessages[messageIndex]); // Debug
            }

            if (currentProgress < 100) {
                setTimeout(updateProgress, 500);
            } else {
                // Używamy komunikatu "Przekierowywanie..." w odpowiednim języku
                loadingDetails.textContent = currentMessages[currentMessages.length - 1];
                console.log("Final message:", currentMessages[currentMessages.length - 1]); // Debug
                
                setTimeout(() => {
                    window.location.href = '{{ target_page }}';
                }, 500);
            }
        }
    }

    // Uruchamiamy po małym opóźnieniu, aby upewnić się, że DOM jest w pełni załadowany i tłumaczenia zastosowane
    setTimeout(() => {
        // Start the progress animation
        updateProgress();
    }, 200);
</script>
{% endblock %}
