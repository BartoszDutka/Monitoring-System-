{% extends "layout.html" %}

{% block content %}
<div class="dashboard-header">
    <h1 data-en="System Logs Monitor" data-pl="Monitor logów systemowych">System Logs Monitor</h1>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card graylog-card full-width">
        <div class="card-header">
            <i class="fas fa-shield-alt"></i>
            <h2 data-en="Critical System Events" data-pl="Krytyczne zdarzenia systemowe">Critical System Events</h2>
            <div class="header-actions">
                <div class="logs-summary">
                    <div class="log-stat error">
                        <span class="stat-label" data-en="Critical Events" data-pl="Zdarzenia krytyczne">Critical Events</span>
                        <span class="stat-count">{{ graylog.stats.error_count }}</span>
                        <div class="stat-content">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                    <div class="log-stat warning">
                        <span class="stat-label" data-en="Warnings" data-pl="Ostrzeżenia">Warnings</span>
                        <span class="stat-count">{{ graylog.stats.warn_count }}</span>
                        <div class="stat-content">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="log-stat info">
                        <span class="stat-label" data-en="Alerts" data-pl="Alerty">Alerts</span>
                        <span class="stat-count">{{ graylog.stats.info_count }}</span>
                        <div class="stat-content">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>                </div>
                {% if has_permission('view_logs') %}
                <button class="refresh-button" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i>
                    <span data-en="Refresh" data-pl="Odśwież">Refresh</span>
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-content">
            <div class="logs-header">
                <div class="time-info">
                    <i class="fas fa-clock"></i>
                    <span class="time-range">{{ graylog.time_range }}</span>
                </div>
                <div class="logs-limit-controls">
                    <span class="limit-label" data-en="Show entries:" data-pl="Pokaż wpisy:">Show entries:</span>
                    <div class="limit-buttons">
                        {% set current_limit = request.args.get('limit', '300')|int %}
                        <button class="limit-btn {% if current_limit == 100 %}active{% endif %}" data-limit="100">100</button>
                        <button class="limit-btn {% if current_limit == 200 %}active{% endif %}" data-limit="200">200</button>
                        <button class="limit-btn {% if current_limit == 300 %}active{% endif %}" data-limit="300">300</button>
                        <button class="limit-btn {% if current_limit == 500 %}active{% endif %}" data-limit="500">500</button>
                        <button class="limit-btn {% if current_limit == 1000 %}active{% endif %}" data-limit="1000">1000</button>
                    </div>
                </div>
            </div>
            
            <div class="logs-categories">
                {% set categories = {
                    'System Error': {'icon': 'fas fa-exclamation-circle', 'class': 'error', 'pl': 'Błędy systemowe'},
                    'Security Alert': {'icon': 'fas fa-shield-alt', 'class': 'security', 'pl': 'Alerty bezpieczeństwa'},
                    'Performance Issue': {'icon': 'fas fa-tachometer-alt', 'class': 'performance', 'pl': 'Problemy wydajnościowe'},
                    'Service Status': {'icon': 'fas fa-server', 'class': 'service', 'pl': 'Status usług'},
                    'General Warning': {'icon': 'fas fa-exclamation-triangle', 'class': 'warning', 'pl': 'Ogólne ostrzeżenia'}
                } %}

                {% for category_name, meta in categories.items() %}
                    {% set category_logs = graylog.logs|selectattr('category', 'equalto', category_name)|list %}
                    {% if category_logs %}
                        <div class="log-category {{ meta.class }}">
                            <div class="category-header" onclick="toggleCategory(this)">
                                <i class="{{ meta.icon }}"></i>
                                <span data-en="{{ category_name }}" data-pl="{{ meta.pl }}">{{ category_name }}</span>
                                <span class="count">{{ category_logs|length }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="category-content">
                                {% for log in category_logs %}
                                    <div class="log-entry {{ log.severity }}">
                                        <div class="log-entry-header">
                                            <div class="header-left">
                                                <span class="timestamp">
                                                    <i class="fas fa-clock"></i>
                                                    {{ log.timestamp }}
                                                </span>
                                                <span class="source">
                                                    <i class="fas fa-user"></i>
                                                    {{ log.details.formsusername if log.details.formsusername else 'Unknown' }}
                                                </span>
                                            </div>
                                            <span class="severity-badge {{ log.severity }}">
                                                {{ log.level }}
                                            </span>
                                        </div>
                                        <div class="log-details">
                                            <!-- Session Information -->
                                            {% if log.details.formssessionname or log.details.formsdbsessionid %}
                                            <div class="detail-section">
                                                <div class="section-header">
                                                    <i class="fas fa-id-card"></i>
                                                    <span data-en="Session Details" data-pl="Szczegóły sesji">Session Details</span>
                                                </div>
                                                <div class="section-content">
                                                    {% if log.details.formssessionname %}
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="Session Name" data-pl="Nazwa sesji">Session Name</span>
                                                        <span class="field-value code">{{ log.details.formssessionname }}</span>
                                                    </div>
                                                    {% endif %}
                                                    {% if log.details.formsdbsessionid %}
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="DB Session ID" data-pl="ID sesji DB">DB Session ID</span>
                                                        <span class="field-value code">{{ log.details.formsdbsessionid }}</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- Form Information -->
                                            {% if log.details.formsformname %}
                                            <div class="detail-section">
                                                <div class="section-header">
                                                    <i class="fas fa-file-alt"></i>
                                                    <span data-en="Form Details" data-pl="Szczegóły formularza">Form Details</span>
                                                </div>
                                                <div class="section-content">
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="Form Name" data-pl="Nazwa formularza">Form Name</span>
                                                        <span class="field-value">{{ log.details.formsformname }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- Technical Information -->
                                            {% if log.details.thread or log.details.callsite %}
                                            <div class="detail-section">
                                                <div class="section-header">
                                                    <i class="fas fa-code"></i>
                                                    <span data-en="Technical Details" data-pl="Szczegóły techniczne">Technical Details</span>
                                                </div>
                                                <div class="section-content">
                                                    {% if log.details.thread %}
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="Thread ID" data-pl="ID wątku">Thread ID</span>
                                                        <span class="field-value code">{{ log.details.thread }}</span>
                                                    </div>
                                                    {% endif %}
                                                    {% if log.details.callsite %}
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="Call Site" data-pl="Miejsce wywołania">Call Site</span>
                                                        <span class="field-value code">{{ log.details.callsite }}</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- Message Content -->
                                            {% if log.message %}
                                            <div class="detail-section message-section">
                                                <div class="message-box {{ log.severity }}">
                                                    <div class="message-header">
                                                        <i class="fas fa-comment-alt"></i>
                                                        <span class="message-type" data-en="Error Message" data-pl="Treść błędu">Error Message</span>
                                                        <span class="message-time">
                                                            <i class="fas fa-clock"></i>
                                                            {{ log.timestamp }}
                                                        </span>
                                                    </div>
                                                    <div class="message-body">
                                                        {{ log.message }}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Translations for dynamic messages
const TRANSLATIONS = {
    'en': {
        'last_minutes': 'Last {} minutes',
        'showing_entries': 'Last {} minutes • Showing {} of {} entries',
        'session_details': 'Session Details',
        'session_name': 'Session Name',
        'db_session_id': 'DB Session ID',
        'form_details': 'Form Details',
        'form_name': 'Form Name',
        'technical_details': 'Technical Details',
        'thread_id': 'Thread ID',
        'call_site': 'Call Site',
        'error_message': 'Error Message',
        'unknown': 'Unknown',
        'loading': 'Loading...',
        'error_loading': 'Error loading data',
        'refresh_complete': 'Refresh complete',
        'no_data_found': 'No log entries found'
    },
    'pl': {
        'last_minutes': 'Ostatnie {} minut',
        'showing_entries': 'Ostatnie {} minut • Wyświetlanie {} z {} wpisów',
        'session_details': 'Szczegóły sesji',
        'session_name': 'Nazwa sesji',
        'db_session_id': 'ID sesji DB',
        'form_details': 'Szczegóły formularza',
        'form_name': 'Nazwa formularza',
        'technical_details': 'Szczegóły techniczne',
        'thread_id': 'ID wątku',
        'call_site': 'Miejsce wywołania',
        'error_message': 'Treść błędu',
        'unknown': 'Nieznany',
        'loading': 'Ładowanie...',
        'error_loading': 'Błąd podczas ładowania danych',
        'refresh_complete': 'Odświeżanie zakończone',
        'no_data_found': 'Nie znaleziono wpisów dziennika'
    }
};

// Get translation for a key based on current language
function __(key, ...args) {
    const language = document.documentElement.getAttribute('data-language') || 'en';
    let message = TRANSLATIONS[language][key] || TRANSLATIONS['en'][key] || key;
    
    if (args.length) {
        args.forEach((arg, i) => {
            message = message.replace(`{}`, arg);
        });
    }
    
    return message;
}

function toggleCategory(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.fa-chevron-down');
    
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = 'rotate(180deg)';
    }
}

function updateLogStats(stats) {
    document.querySelector('.log-stat.error .stat-count').textContent = stats.error_count;
    document.querySelector('.log-stat.warning .stat-count').textContent = stats.warn_count;
    document.querySelector('.log-stat.info .stat-count').textContent = stats.info_count;
}

function updateLogContent(logs) {
    const categories = {
        'System Error': {'icon': 'fas fa-exclamation-circle', 'class': 'error', 'pl': 'Błędy systemowe'},
        'Security Alert': {'icon': 'fas fa-shield-alt', 'class': 'security', 'pl': 'Alerty bezpieczeństwa'},
        'Performance Issue': {'icon': 'fas fa-tachometer-alt', 'class': 'performance', 'pl': 'Problemy wydajnościowe'},
        'Service Status': {'icon': 'fas fa-server', 'class': 'service', 'pl': 'Status usług'},
        'General Warning': {'icon': 'fas fa-exclamation-triangle', 'class': 'warning', 'pl': 'Ogólne ostrzeżenia'}
    };

    const language = document.documentElement.getAttribute('data-language') || 'en';
    const logsCategories = document.querySelector('.logs-categories');
    logsCategories.innerHTML = '';

    // Grupuj logi według kategorii
    const logsByCategory = {};
    logs.forEach(log => {
        if (!logsByCategory[log.category]) {
            logsByCategory[log.category] = [];
        }
        logsByCategory[log.category].push(log);
    });

    // Generuj HTML dla każdej kategorii
    Object.entries(categories).forEach(([categoryName, meta]) => {
        const categoryLogs = logsByCategory[categoryName] || [];
        if (categoryLogs.length) {
            const displayName = language === 'pl' ? meta.pl : categoryName;
            const categoryHTML = `
                <div class="log-category ${meta.class}">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <i class="${meta.icon}"></i>
                        <span data-en="${categoryName}" data-pl="${meta.pl}">${displayName}</span>
                        <span class="count">${categoryLogs.length}</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="category-content">
                        ${categoryLogs.map(log => `
                            <div class="log-entry ${log.severity}">
                                <div class="log-entry-header">
                                    <div class="header-left">
                                        <span class="timestamp">
                                            <i class="fas fa-clock"></i>
                                            ${log.timestamp}
                                        </span>
                                        <span class="source">
                                            <i class="fas fa-user"></i>
                                            ${log.details.formsusername || __('unknown')}
                                        </span>
                                    </div>
                                    <span class="severity-badge ${log.severity}">
                                        ${log.level}
                                    </span>
                                </div>
                                <div class="log-details">
                                    ${log.details.formssessionname || log.details.formsdbsessionid ? `
                                        <div class="detail-section">
                                            <div class="section-header">
                                                <i class="fas fa-id-card"></i>
                                                <span data-en="Session Details" data-pl="Szczegóły sesji">${__('session_details')}</span>
                                            </div>
                                            <div class="section-content">
                                                ${log.details.formssessionname ? `
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="Session Name" data-pl="Nazwa sesji">${__('session_name')}</span>
                                                        <span class="field-value code">${log.details.formssessionname}</span>
                                                    </div>
                                                ` : ''}
                                                ${log.details.formsdbsessionid ? `
                                                    <div class="detail-field">
                                                        <span class="field-label" data-en="DB Session ID" data-pl="ID sesji DB">${__('db_session_id')}</span>
                                                        <span class="field-value code">${log.details.formsdbsessionid}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${log.message ? `
                                        <div class="detail-section message-section">
                                            <div class="message-box ${log.severity}">
                                                <div class="message-header">
                                                    <i class="fas fa-comment-alt"></i>
                                                    <span class="message-type" data-en="Error Message" data-pl="Treść błędu">${__('error_message')}</span>
                                                    <span class="message-time">
                                                        <i class="fas fa-clock"></i>
                                                        ${log.timestamp}
                                                    </span>
                                                </div>
                                                <div class="message-body">
                                                    ${log.message}
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            logsCategories.insertAdjacentHTML('beforeend', categoryHTML);
        }
    });
    
    // Apply translations after inserting the content
    applyTranslations();
    
    if (Object.keys(logsByCategory).length === 0) {
        logsCategories.innerHTML = `<div class="no-logs-message">${__('no_data_found')}</div>`;
    }
}

// Funkcja do ustawiania aktywnego przycisku limitu
function setActiveLimit(limit) {
    document.querySelectorAll('.limit-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-limit') === String(limit));
    });
}

// Zmodyfikowana funkcja refreshLogs
function refreshLogs() {
    const button = document.querySelector('.refresh-button');
    const icon = button.querySelector('i');
    const buttonText = button.querySelector('span');
    const originalText = buttonText.textContent;
    
    button.disabled = true;
    icon.classList.add('fa-spin');
    buttonText.textContent = __('loading');
    
    // Pobierz aktualny limit
    const currentLimit = sessionStorage.getItem('graylog_limit') || 
                        new URLSearchParams(window.location.search).get('limit') || 
                        '300';
    
    fetch(`/api/graylog/refresh?limit=${currentLimit}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateLogStats(data.stats);
            document.querySelector('.time-range').textContent = data.time_range;
            
            return fetch(`/api/graylog/messages?limit=${currentLimit}`);
        } else {
            throw new Error(__('error_loading'));
        }
    })
    .then(response => response.json())
    .then(data => {
        updateLogContent(data.logs);
        buttonText.textContent = __('refresh_complete');
        setTimeout(() => {
            buttonText.textContent = originalText;
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        buttonText.textContent = __('error_loading');
        setTimeout(() => {
            buttonText.textContent = originalText;
        }, 1500);
    })
    .finally(() => {
        button.disabled = false;
        icon.classList.remove('fa-spin');
    });
}

// Apply translations based on current language
function applyTranslations() {
    const language = document.documentElement.getAttribute('data-language') || 'en';
    document.querySelectorAll('[data-en]').forEach(element => {
        if (language === 'pl' && element.hasAttribute('data-pl')) {
            element.textContent = element.getAttribute('data-pl');
        } else {
            element.textContent = element.getAttribute('data-en');
        }
    });
}

// Przy załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // Pobierz limit z URL lub z sesji
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || sessionStorage.getItem('graylog_limit') || '300';
    
    // Zapisz limit w sessionStorage
    sessionStorage.setItem('graylog_limit', limit);
    
    // Ustaw aktywny przycisk
    setActiveLimit(limit);
    
    // Apply initial translations
    applyTranslations();
    
    // Display loading message
    document.querySelector('.logs-categories').innerHTML = `<div class="loading-message">${__('loading')}</div>`;
    
    // Od razu pobierz dane z właściwym limitem
    fetch(`/api/graylog/messages?limit=${limit}`)
        .then(response => response.json())
        .then(data => {
            updateLogStats(data.stats);
            updateLogContent(data.logs);
            document.querySelector('.time-range').textContent = 
                __('showing_entries', 5, limit, data.total_results);
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('.logs-categories').innerHTML = `<div class="error-message">${__('error_loading')}</div>`;
        });
        
    // Listen for language changes
    document.addEventListener('languageChanged', function(e) {
        applyTranslations();
    });
});

// Zmodyfikowane nasłuchiwanie kliknięć przycisków limitu
document.querySelectorAll('.limit-btn').forEach(button => {
    button.addEventListener('click', function() {
        const limit = this.getAttribute('data-limit');
        
        // Zapisz nowy limit w sessionStorage
        sessionStorage.setItem('graylog_limit', limit);
        
        // Aktualizuj aktywny przycisk
        setActiveLimit(limit);
        
        // Display loading message
        document.querySelector('.logs-categories').innerHTML = `<div class="loading-message">${__('loading')}</div>`;
        
        // Pobierz dane dla nowego limitu
        fetch(`/api/graylog/messages?limit=${limit}`)
            .then(response => response.json())
            .then(data => {
                updateLogStats(data.stats);
                updateLogContent(data.logs);
                document.querySelector('.time-range').textContent = 
                    __('showing_entries', 5, limit, data.total_results);
                
                // Zaktualizuj URL bez przeładowania strony
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('limit', limit);
                window.history.pushState({}, '', newUrl);
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('.logs-categories').innerHTML = `<div class="error-message">${__('error_loading')}</div>`;
            });
    });
});

// Odświeżaj co 30 sekund
setInterval(refreshLogs, 30000);

</script>
{% endblock %}
