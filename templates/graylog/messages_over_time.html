{% extends "layout/layout.html" %}

{% block content %}
<div class="dashboard-header">
    <h1 data-en="Messages Over Time" data-pl="Wiadomości w czasie">Messages Over Time</h1>
    <div class="header-controls">
        <div class="time-controls">
            <div class="control-group">
                <label data-en="Time Range:" data-pl="Zakres czasu:">Time Range:</label>
                <div class="select-group">
                    <select id="timeRangeValue" onchange="updateChart()">
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                        <option value="60">60</option>
                    </select>
                    <select id="timeRangeUnit" onchange="updateTimeOptions()">
                        <option value="minutes" data-en="Minutes" data-pl="Minuty">Minutes</option>
                        <option value="hours" data-en="Hours" data-pl="Godziny">Hours</option>
                        <option value="days" data-en="Days" data-pl="Dni">Days</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label data-en="Interval:" data-pl="Interwał:">Interval:</label>
                <select id="timeInterval" onchange="updateChart()">
                    <!-- Options will be added dynamically -->
                </select>            </div>
            {% if has_permission('view_logs') %}
            <button class="refresh-button" onclick="refreshChart()">
                <i class="fas fa-sync"></i>
                <span data-en="Refresh" data-pl="Odśwież">Refresh</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card graylog-card full-width">
        <div class="card-content">
            <div class="chart-container">
                <canvas id="messageTimeline"></canvas>
            </div>
            <div class="timeline-stats">
                <div class="stat-box">
                    <h3 data-en="Total Messages" data-pl="Łączna liczba wiadomości">Total Messages</h3>
                    <span class="stat-value">{{ graylog.total_results }}</span>
                </div>
                <div class="stat-box error">
                    <h3 data-en="Errors" data-pl="Błędy">Errors</h3>
                    <span class="stat-value">{{ graylog.stats.error_count }}</span>
                </div>
                <div class="stat-box warning">
                    <h3 data-en="Warnings" data-pl="Ostrzeżenia">Warnings</h3>
                    <span class="stat-value">{{ graylog.stats.warn_count }}</span>
                </div>
                <div class="stat-box info">
                    <h3 data-en="Info" data-pl="Informacje">Info</h3>
                    <span class="stat-value">{{ graylog.stats.info_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script>
let timelineChart;

function updateTimeOptions() {
    const rangeUnit = document.getElementById('timeRangeUnit').value;
    const rangeSelect = document.getElementById('timeRangeValue');
    const intervalSelect = document.getElementById('timeInterval');
    const language = document.documentElement.getAttribute('data-language') || 'en';
    
    // Wyczyść opcje
    rangeSelect.innerHTML = '';
    intervalSelect.innerHTML = '';
    
    // Ustaw opcje zakresu czasu i interwałów w zależności od wybranej jednostki
    if (rangeUnit === 'minutes') {
        [15, 30, 45, 60].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla minut pokazuj interwały 1-5 minut
        [1, 2, 5, 10, 15].forEach(val => {
            const label = language === 'pl' ? 
                `${val} ${val === 1 ? 'minuta' : val < 5 ? 'minuty' : 'minut'}` : 
                `${val} minute${val > 1 ? 's' : ''}`;
            intervalSelect.add(new Option(label, `${val} minutes`));
        });
    } else if (rangeUnit === 'hours') {
        [1, 2, 3, 6, 12, 24].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla godzin pokazuj interwały 15-60 minut
        [15, 30, 60].forEach(val => {
            const label = language === 'pl' ? 
                `${val} ${val === 1 ? 'minuta' : val < 5 ? 'minuty' : 'minut'}` : 
                `${val} minutes`;
            intervalSelect.add(new Option(label, `${val} minutes`));
        });
    } else { // days
        [1, 2, 3, 7, 14, 30].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla dni pokazuj interwały w dniach
        [1].forEach(val => {
            const label = language === 'pl' ? 
                `${val} ${val === 1 ? 'dzień' : 'dni'}` : 
                `${val} day`;
            intervalSelect.add(new Option(label, `${val} day`));
        });
    }
    
    updateChart();
}

function updateChart() {
    const rangeValue = document.getElementById('timeRangeValue').value;
    const rangeUnit = document.getElementById('timeRangeUnit').value;
    const interval = document.getElementById('timeInterval').value;
    const button = document.querySelector('.refresh-button');
    const icon = button.querySelector('i');
    const language = document.documentElement.getAttribute('data-language') || 'en';
    
    button.disabled = true;
    icon.classList.add('fa-spin');
    
    fetch(`/api/graylog/timeline?range=${rangeValue}&range_type=${rangeUnit}&interval=${interval}&language=${language}`)
        .then(response => response.json())
        .then(data => {
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            const ctx = document.getElementById('messageTimeline').getContext('2d');
            
            // Translate chart labels based on language
            if (language === 'pl') {
                // Translate dataset labels
                data.datasets.forEach(dataset => {
                    if (dataset.label === 'Errors') dataset.label = 'Błędy';
                    if (dataset.label === 'Warnings') dataset.label = 'Ostrzeżenia';
                    if (dataset.label === 'Info') dataset.label = 'Informacje';
                    
                    // Dodajemy również tłumaczenie dla etykiet priorytetów, jeśli są jeszcze w języku angielskim
                    if (dataset.label === 'High Priority') dataset.label = 'Wysoki';
                    if (dataset.label === 'Medium Priority') dataset.label = 'Średni';
                    if (dataset.label === 'Low Priority') dataset.label = 'Niski';
                });
            }
            
            const rangeUnitTranslation = {
                'minutes': language === 'pl' ? 'minut' : 'minutes',
                'hours': language === 'pl' ? 'godzin' : 'hours',
                'days': language === 'pl' ? 'dni' : 'days'
            };
            
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: language === 'pl' ? 
                                `Rozkład wiadomości (ostatnie ${rangeValue} ${rangeUnitTranslation[rangeUnit]})` :
                                `Message Distribution (Last ${rangeValue} ${rangeUnit})`
                        }
                    }
                }
            });
            
            updateStats(data);
        })
        .catch(error => console.error('Error updating chart:', error))
        .finally(() => {
            button.disabled = false;
            icon.classList.remove('fa-spin');
        });
}

function updateStats(data) {
    const total = data.datasets.reduce((acc, dataset) => 
        acc + dataset.data.reduce((sum, val) => sum + val, 0), 0);
    
    document.querySelector('.stat-box .stat-value').textContent = total;
    document.querySelector('.stat-box.error .stat-value').textContent = 
        data.datasets[0].data.reduce((sum, val) => sum + val, 0);
    document.querySelector('.stat-box.warning .stat-value').textContent = 
        data.datasets[1].data.reduce((sum, val) => sum + val, 0);
    document.querySelector('.stat-box.info .stat-value').textContent = 
        data.datasets[2].data.reduce((sum, val) => sum + val, 0);
}

function refreshChart() {
    updateChart();
}

// Inicjalizacja
document.addEventListener('DOMContentLoaded', () => {
    updateTimeOptions();
    
    // Nasłuchuj zmian języka
    document.addEventListener('languageChanged', function(e) {
        // Update selector options
        updateTimeOptions();
        
        // Wymuś odświeżenie wykresu po zmianie języka, aby zaktualizować etykiety
        updateChart();
    });
    
    // Nasłuchuj zmian zakresu czasu
    document.getElementById('timeRangeUnit').addEventListener('change', updateTimeOptions);
    
    // Odświeżaj co 5 minut
    setInterval(refreshChart, 300000);
});
</script>
{% endblock %}
