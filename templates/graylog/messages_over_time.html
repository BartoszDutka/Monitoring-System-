{% extends "layout.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>Messages Over Time</h1>
    <div class="header-controls">
        <div class="time-controls">
            <div class="control-group">
                <label>Time Range:</label>
                <div class="select-group">
                    <select id="timeRangeValue" onchange="updateChart()">
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                        <option value="60">60</option>
                    </select>
                    <select id="timeRangeUnit" onchange="updateTimeOptions()">
                        <option value="minutes">Minutes</option>
                        <option value="hours">Hours</option>
                        <option value="days">Days</option>
                    </select>
                </div>
            </div>
            <div class="control-group">
                <label>Interval:</label>
                <select id="timeInterval" onchange="updateChart()">
                    <!-- Opcje będą dodawane dynamicznie -->
                </select>
            </div>
            <button class="refresh-button" onclick="refreshChart()">
                <i class="fas fa-sync"></i>
                Refresh
            </button>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card graylog-card full-width">
        <div class="card-content">
            <div class="chart-container">
                <canvas id="messageTimeline"></canvas>
            </div>
            <div class="timeline-stats">
                <div class="stat-box">
                    <h3>Total Messages</h3>
                    <span class="stat-value">{{ graylog.total_results }}</span>
                </div>
                <div class="stat-box error">
                    <h3>Errors</h3>
                    <span class="stat-value">{{ graylog.stats.error_count }}</span>
                </div>
                <div class="stat-box warning">
                    <h3>Warnings</h3>
                    <span class="stat-value">{{ graylog.stats.warn_count }}</span>
                </div>
                <div class="stat-box info">
                    <h3>Info</h3>
                    <span class="stat-value">{{ graylog.stats.info_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.time-controls {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.control-group label {
    font-weight: 500;
    color: white;
    white-space: nowrap;
}

.select-group {
    display: flex;
    gap: 0.5rem;
}

.time-controls select {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    min-width: 100px;
}

.refresh-button {
    margin-left: auto;
}

@media (max-width: 768px) {
    .time-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .control-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .refresh-button {
        margin-left: 0;
        width: 100%;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script>
let timelineChart;

function updateTimeOptions() {
    const rangeUnit = document.getElementById('timeRangeUnit').value;
    const rangeSelect = document.getElementById('timeRangeValue');
    const intervalSelect = document.getElementById('timeInterval');
    
    // Wyczyść opcje
    rangeSelect.innerHTML = '';
    intervalSelect.innerHTML = '';
    
    // Ustaw opcje zakresu czasu i interwałów w zależności od wybranej jednostki
    if (rangeUnit === 'minutes') {
        [15, 30, 45, 60].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla minut pokazuj interwały 1-5 minut
        [1, 2, 5, 10, 15].forEach(val => {
            intervalSelect.add(new Option(`${val} minute${val > 1 ? 's' : ''}`, `${val} minutes`));
        });
    } else if (rangeUnit === 'hours') {
        [1, 2, 3, 6, 12, 24].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla godzin pokazuj interwały 15-60 minut
        [15, 30, 60].forEach(val => {
            intervalSelect.add(new Option(`${val} minutes`, `${val} minutes`));
        });
    } else { // days
        [1, 2, 3, 7, 14, 30].forEach(val => {
            rangeSelect.add(new Option(`${val}`, val));
        });
        // Dla dni pokazuj interwały w dniach
        [1].forEach(val => {
            intervalSelect.add(new Option(`${val} day`, `${val} day`));
        });
    }
    
    updateChart();
}

function updateChart() {
    const rangeValue = document.getElementById('timeRangeValue').value;
    const rangeUnit = document.getElementById('timeRangeUnit').value;
    const interval = document.getElementById('timeInterval').value;
    const button = document.querySelector('.refresh-button');
    const icon = button.querySelector('i');
    
    button.disabled = true;
    icon.classList.add('fa-spin');
    
    fetch(`/api/graylog/timeline?range=${rangeValue}&range_type=${rangeUnit}&interval=${interval}`)
        .then(response => response.json())
        .then(data => {
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            const ctx = document.getElementById('messageTimeline').getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `Message Distribution (Last ${rangeValue} ${rangeUnit})`
                        }
                    }
                }
            });
            
            updateStats(data);
        })
        .catch(error => console.error('Error updating chart:', error))
        .finally(() => {
            button.disabled = false;
            icon.classList.remove('fa-spin');
        });
}

function updateStats(data) {
    const total = data.datasets.reduce((acc, dataset) => 
        acc + dataset.data.reduce((sum, val) => sum + val, 0), 0);
    
    document.querySelector('.stat-box .stat-value').textContent = total;
    document.querySelector('.stat-box.error .stat-value').textContent = 
        data.datasets[0].data.reduce((sum, val) => sum + val, 0);
    document.querySelector('.stat-box.warning .stat-value').textContent = 
        data.datasets[1].data.reduce((sum, val) => sum + val, 0);
    document.querySelector('.stat-box.info .stat-value').textContent = 
        data.datasets[2].data.reduce((sum, val) => sum + val, 0);
}

function refreshChart() {
    updateChart();
}

// Inicjalizacja
document.addEventListener('DOMContentLoaded', () => {
    updateTimeOptions();
    
    // Nasłuchuj zmian zakresu czasu
    document.getElementById('timeRangeUnit').addEventListener('change', updateTimeOptions);
    
    // Odświeżaj co 5 minut
    setInterval(refreshChart, 300000);
});
</script>
{% endblock %}
